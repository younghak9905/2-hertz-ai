name: Notify Discord on PR Merged to Develop

on:
  pull_request:
    types: [closed] # PRì´ ë‹«í˜”ì„ ë•Œ (ë³‘í•© í¬í•¨)
    branches:
      - main
      - develop # develop ë¸Œëœì¹˜ë¡œ PR ë³‘í•© ì‹œ ê°ì§€

jobs:
  notify:
    if: github.event.pull_request.merged == true # ë³‘í•©ëœ ê²½ìš°ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification (embed)
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_BODY: ${{ github.event.pull_request.body }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_PR_URL }}
        run: |
          # PR_BODYê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì„¤ì •
          SAFE_BODY="${PR_BODY:-ë‚´ìš© ì—†ìŒ}"

          # description ê¸¸ì´ ì œí•œ (DiscordëŠ” 4096ì ì œí•œ ìˆìŒ)
          SAFE_BODY_TRUNCATED=$(echo "$SAFE_BODY" | head -c 3500)

          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•œ JSON ìƒì„±
          PAYLOAD=$(jq -n \
            --arg title "âœ… PR Merged to \`$BASE_BRANCH\`! [PR ë§í¬]" \
            --arg url "$PR_URL" \
            --arg desc "**Title:** $PR_TITLE\n**Author:** $PR_AUTHOR\n\nğŸ“ **Description:**\n\`\`\`\n$SAFE_BODY_TRUNCATED\n\`\`\`" \
            '{
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: $desc,
                  color: 3066993
                }
              ]
            }')

          # ë©”ì‹œì§€ ì „ì†¡
          curl -v -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"